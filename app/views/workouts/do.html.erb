<%= javascript_include_tag "jquery-2.1.1.min.js" %>
<%= javascript_include_tag "jquery-ui.min.js" %>
<%= javascript_include_tag "color.js" %>
<%= stylesheet_link_tag "excersise_do.css" %>
<%= stylesheet_link_tag "jquery-ui.css" %>

<script>
var excersise_group_order = <%= @excersise_group_order.to_json %>;
var largest_group = <%= @largest_group %>;

var group_starting_excersise = <%= @group_starting_excersise.to_json %>
var excersise_information = {};
<% @excersises.each do |excersise| %>
excersise_information[<%= excersise.id %>] = <%= @excersise_information[excersise.id] %>
<%  end %>

var last_toggled = -1;
var current_excersise_id = <%= @excersises[0].id %>

var resting = false;
var finished = false;

$(function () {
	
	var max_range = largest_group;
	if( max_range < 10 ) max_range = 10;

	var i = 0;
	$("#excersises").children().each( function() {
		
		if( $(this).attr('id').indexOf("rest") == -1 )
		{
			var rgb = HSBtoRGB(excersise_group_order[i] * (100.0/max_range), 0.68, 0.66);
			$(this).animate({backgroundColor: "rgb(" + parseInt(rgb[0]) + ", " + parseInt(rgb[1]) + ", " + parseInt(rgb[2]) + ")"});

			i += 1;
		}
		});

	$("#excersise_letter_" + current_excersise_id).animate({backgroundColor: "#2196F3"});

	});

function toggle_sets(id)
{
	if( id == last_toggled )
	{
		last_toggled = -1;
	}
	else if( last_toggled == -1 )
	{
		last_toggled = id;
	}
	else
	{
		toggle_sets(last_toggled);
		last_toggled = id;
	}

	if( $("#excersise_" + id).width() == 350 )
	{
		var new_height = ($("#excersise_sets_" + id).height() + 140);
		if( new_height < 300 ) new_height = 300;

		$("#excersise_" + id).animate({width: "700px", height: (new_height + "px")}, 200, function() {
				$("#excersise_sets_" + id).css({visibility: "visible"});
				});
	}
	else
	{
		$("#excersise_sets_" + id).css({visibility: "hidden"});
		$("#excersise_" + id).animate({width: "350px", height: "300px"}, 200);
	}
}

function next(id)
{
	//var possible_next_id = excersise_information[current_excersise_id][0];
	var next_id = -1;

	// Make sure the right button was clicked
	if( !( resting && id == ("group_" + excersise_information[current_excersise_id][1]) ) && !( !resting && id == current_excersise_id ) )
	{
		return false;
	}

	if( resting )
	{
		$("#rest_group_" + excersise_information[current_excersise_id][1]).animate({backgroundColor: "rgba(255, 255, 255, 0.2)"});

		// Subtract 1 from the index because the grouops are indexeded 1 .. * but the 
		// array is 0 .. *-1
		var group_start_id = group_starting_excersise[excersise_information[current_excersise_id][1] - 1];
		//resting = false;

		// Make sure that the next excersise has sets left
		if( excersise_information[group_start_id][2] > 0 )
		{
			next_id = group_start_id;	
		}
		else
		{
			current_excersise_id = group_start_id;
		}
	}
	else
	{
		excersise_information[current_excersise_id][2] -= 1;
		$("#excersise_letter_" + current_excersise_id).animate({backgroundColor: "rgba(255, 255, 255, 0.2)"});
	}
	
	var possible_next_id = excersise_information[current_excersise_id][0];
	
	// Find an excersise in the current group after the current excersise
	// that still has sets left to do
	while( next_id == -1 && possible_next_id != -1 )
	{
		if( excersise_information[possible_next_id][2] > 0 )
		{
			next_id = possible_next_id;
		}
		else
		{
			possible_next_id = excersise_information[possible_next_id][0];
		}		
	}
	
	// If the next excersise was found then highlight the next
	// excersise
	if( next_id != -1 )
	{
		//$("#excersise_letter_" + current_excersise_id).animate({"backgroundColor": "rgba(255,255,255, 0.2)"});
		resting = false;

		current_excersise_id = next_id;
		$("#excersise_letter_" + current_excersise_id).animate({backgroundColor: "#2196F3"});

		//excersise_information[current_excersise_id][2] -= 1;
	}
	else if( next_id == -1 && resting )
	{
		if( excersise_information[current_excersise_id][1] < group_starting_excersise.length )
		{
			current_excersise_id = group_starting_excersise[excersise_information[current_excersise_id][1]];

			//current_excersise_id = next_id;
			$("#excersise_letter_" + current_excersise_id).animate({backgroundColor: "#2196F3"});

			//excersise_information[current_excersise_id][2] -= 1;

			resting = false;

		}
		else
		{
			$("#rest_group_done").animate({backgroundColor: "#2196F3"});
			finished = true;

		}
	}
	// Else the set is finished so if this wasnt the last set then highlight the rest box
	else //if( excersise_information[current_excersise_id][1] != largest_group )
	{
		$("#rest_group_" + excersise_information[current_excersise_id][1]).animate({backgroundColor: "#2196F3"});
		resting = true;
	}
	// Otherwise the workout has been finished
	//else
	//{
	//	$("#rest_group_done").animate({"backgroudColor": "#2196F3"});
	//	finished = true;
	//}
}

function finish()
{
	if( !finished )
	{
		return false;
	}

	window.location = "/";
}

</script>

<div id="container">
	<div id="excersises">
		<% @last_group = @excersises[0].group %>
		<% @excersises.each do |excersise| %>
			<% if excersise.group != @last_group %>
			<div id="rest_<%= @last_excersise %>" class="rest">
				<div id="rest_group_<%= @last_group %>" class="rest_group">
					<%= @last_group %>
				</div>

				<div class="rest_text">
					Rest Now
				</div>

				<div class="rest_buttons">
					<div id="next_button_<%= @last_group %>" class="button" onclick="next('group_<%= @last_group %>')">
						NEXT
					</div>
				</div>
			</div>

			<% @last_group = excersise.group %>
			<% end %>

			<div id="excersise_<%= excersise.id %>" class="excersise">

			<div id="excersise_letter_<%= excersise.id %>" class="excersise_letter" onclick="toggle_sets(<%= excersise.id %>)">
				<%= excersise.name[0] %>
			</div>
			
			<div id="excersise_information_<%= excersise.id %>" class="excersise_information">
				<div id="excersise_name_<%= excersise.id %>" class="excersise_name">
					<%= excersise.name %>
				</div>

				<div id="excersise_usual_<%= excersise.id %>" class="excersise_usual">
					<%= "Usual set is #{excersise.reps} reps" %> <%= if excersise.excersisetype != 3 then; " at #{excersise.diffculty} #{excersise.get_units}"; end %>
				</div>

				<div id="excersise_buttons_<%= excersise.id %>" class="excersise_buttons">
					<div id="go_button_<%= excersise.id %>" class="button">
						GO!
					</div>

					<div id="done_button_<%= excersise.id %>" class="button" onclick="next(<%= excersise.id %>)"> 
						DONE
					</div>
				</div>
			</div>

			<div id="excersise_sets_<%= excersise.id %>" class="excersise_sets">

				<% (1..excersise.sets).each do |i| %>
				<div id="excersise_set_<%= excersise.id %>_<%= i %>" class="excersise_set">
						
					<div class="excersise_set_number">
						Set <%= i %>
					</div>

					<div id="excersise_set_reps_<%= excersise.id %>_<%= i %>" class="excersise_set_reps">

					</div>

					<div id="excersise_set_diffculty_<%= excersise.id %>_<%= i %>" class="excersise_set_diffculty">

					</div>

					<div class="excersise_set_diffculty_units">
						<%= excersise.get_units %>
					</div>
				</div>
				<% end %>
			</div>
		</div>
		<% end %>

		<div id="rest_<%= @largest_group %>" class="rest">
			<div id="rest_group_<%= @largest_group %>" class="rest_group">
				<%= @last_group %>
			</div>

			<div class="rest_text">
				Rest Now
			</div>

			<div class="rest_buttons">
				<div id="next_button_<%= @largest_group %>" class="button" onclick="next('group_<%= @largest_group %>')">
					NEXT
				</div>
			</div>
		</div>
		
		<div id="rest_done" class="rest">
			<div id="rest_group_done" class="rest_group">
				D
			</div>

			<div class="rest_text">
				Workout Done
			</div>

			<div class="rest_buttons">
				<div id="finish_button" class="button" onclick="finish()">
					FINISH
				</div>
			</div>
		</div>

	</div>
</div>
